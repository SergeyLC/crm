version: "3.9"

services:
  # ==================== Nginx ====================
  nginx:
    image: nginx:alpine
    container_name: loyacrm-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    networks: [loyacrm-network]

  # ==================== Frontend ====================
  frontend:
    image: ${FRONTEND_IMAGE:-loyacrm-frontend:latest}
    container_name: loyacrm-frontend
    restart: unless-stopped
    environment:
      - PORT=${FRONTEND_PORT:-3000}
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-/api}
      - NEXT_PUBLIC_BACKEND_API_URL=${NEXT_PUBLIC_BACKEND_API_URL}
      - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-production}
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:${FRONTEND_PORT:-3000} || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks: [loyacrm-network]

  # ==================== Backend ====================
  backend:
    image: ${BACKEND_IMAGE:-loyacrm-backend:latest}
    container_name: loyacrm-backend
    restart: unless-stopped
    environment:
      - PORT=${BACKEND_PORT:-4000}
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-loyacrm}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-loyacrm}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:${BACKEND_PORT:-4000}/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks: [loyacrm-network]

  # ==================== PostgreSQL ====================
  postgres:
    image: postgres:16-alpine
    container_name: loyacrm-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER:-loyacrm}
      - POSTGRES_DB=${POSTGRES_DB:-loyacrm}
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-loyacrm}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks: [loyacrm-network]

# ==================== Volumes & Networks ====================
volumes:
  pg_data:
    name: loyacrm_pg_data

networks:
  loyacrm-network:
    driver: bridge

# ==================== Secrets ====================
secrets:
  db_password:
    file: ./secrets/db_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
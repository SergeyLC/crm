# Nginx Optimization Guide

## üöÄ Performance Improvements

–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –¥–æ–±–∞–≤–ª—è–µ—Ç:

### 1. **Gzip —Å–∂–∞—Ç–∏–µ (—ç–∫–æ–Ω–æ–º–∏—Ç 70-80% —Ç—Ä–∞—Ñ–∏–∫–∞)**
```nginx
gzip on;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript...;
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ 500KB ‚Üí 100KB

### 2. **HTTP/2 (—É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 30-50%)**
```nginx
listen 443 ssl http2;
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤, –º–µ–Ω—å—à–µ latency

### 3. **Aggressive –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏**
- `_next/static/` - 1 –≥–æ–¥ (immutable)
- `_next/image` - 1 –≥–æ–¥
- `/public/` - 1 —á–∞—Å
- `favicon.ico` - 1 –¥–µ–Ω—å

**–≠—Ñ—Ñ–µ–∫—Ç:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤–∏–∑–∏—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

### 4. **Rate Limiting (–∑–∞—â–∏—Ç–∞ –æ—Ç DDoS)**
```nginx
limit_req zone=api_limit burst=5 nodelay;  # API: 10 req/s
limit_req zone=general_limit burst=20 nodelay;  # Frontend: 30 req/s
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

### 5. **Connection Keepalive**
```nginx
upstream frontend {
    server localhost:3000;
    keepalive 64;  # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
}
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –ú–µ–Ω—å—à–µ TCP handshakes, –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–∫–ª–∏–∫

### 6. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä—ã**
```nginx
client_max_body_size 10M;  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–æ 10MB
proxy_buffers 8 4k;  # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è
```

## üìã –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### –®–∞–≥ 1: Backup —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
sudo cp /etc/nginx/sites-available/loyacrm /etc/nginx/sites-available/loyacrm.backup
```

### –®–∞–≥ 2: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```bash
# –ò–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ .github/nginx-optimized.conf
sudo cp /path/to/repo/.github/nginx-optimized.conf /etc/nginx/sites-available/loyacrm
```

### –®–∞–≥ 3: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –≤–∞—à –¥–æ–º–µ–Ω
```bash
sudo nano /etc/nginx/sites-available/loyacrm
```

–ó–∞–º–µ–Ω–∏—Ç–µ:
- `your-domain.com` ‚Üí –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω
- `www.your-domain.com` ‚Üí –≤–∞—à www –¥–æ–º–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```bash
sudo nginx -t
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### –®–∞–≥ 5: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
```bash
sudo systemctl reload nginx
```

### –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å gzip
```bash
curl -H "Accept-Encoding: gzip" -I https://your-domain.com
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
Content-Encoding: gzip
```

### –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL –∏ HTTP/2

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:
```bash
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- ‚úÖ –î–æ–±–∞–≤–∏—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- ‚úÖ –í–∫–ª—é—á–∏—Ç HTTP/2
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç HTTP ‚Üí HTTPS
- ‚úÖ –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

## üìä –ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```bash
curl -w "@curl-format.txt" -o /dev/null -s https://your-domain.com
```

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```bash
# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# - time_total: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 30-50%
# - size_download: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 70-80% (–±–ª–∞–≥–æ–¥–∞—Ä—è gzip)
```

### –¢–µ—Å—Ç —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏:
- **Google PageSpeed Insights**: https://pagespeed.web.dev/
- **GTmetrix**: https://gtmetrix.com/
- **WebPageTest**: https://www.webpagetest.org/

**–û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- PageSpeed Score: +20-30 –±–∞–ª–ª–æ–≤
- First Contentful Paint: -30-40%
- Time to Interactive: -20-30%

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
```bash
sudo ss -s
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limiting:
```bash
sudo tail -f /var/log/nginx/error.log | grep limiting
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à headers:
```bash
curl -I https://your-domain.com/_next/static/chunks/main.js
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: Cache-Control: public, max-age=31536000, immutable
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Rate limiting –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–µ–≥–∏—Ç–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏ 503 - —É–≤–µ–ª–∏—á—å—Ç–µ `burst` –∑–Ω–∞—á–µ–Ω–∏—è
   - –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã: API 10 req/s, Frontend 30 req/s

2. **client_max_body_size —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 10MB**
   - –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª—ã –±–æ–ª—å—à–µ ‚Üí —É–≤–µ–ª–∏—á—å—Ç–µ
   - –ü—Ä–∏–º–µ—Ä: `client_max_body_size 50M;`

3. **Gzip —Å–∂–∞—Ç–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CPU**
   - `gzip_comp_level 6` - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ —Å–∂–∞—Ç–∏–µ–º
   - –ï—Å–ª–∏ CPU –∑–∞–≥—Ä—É–∂–µ–Ω ‚Üí —É–º–µ–Ω—å—à–∏—Ç–µ –¥–æ 4
   - –ï—Å–ª–∏ CPU —Å–≤–æ–±–æ–¥–µ–Ω ‚Üí —É–≤–µ–ª–∏—á—å—Ç–µ –¥–æ 9

4. **–ü–æ—Å–ª–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞**
   - –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ HTTPS server block
   - –í–∫–ª—é—á–∏—Ç–µ HSTS (–ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!)

## üéØ Staging –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–î–ª—è staging –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, –Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ—Ä—Ç–∞–º–∏:
- Frontend: `localhost:3001` (–≤–º–µ—Å—Ç–æ 3000)
- Backend: `localhost:4001` (–≤–º–µ—Å—Ç–æ 4000)
- Rate limits: –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ (staging –¥–ª—è —Ç–µ—Å—Ç–æ–≤)

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ~500KB
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: ~2-3 —Å–µ–∫—É–Ω–¥—ã
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤: ~40

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ~100KB (gzip)
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: ~0.8-1.2 —Å–µ–∫—É–Ω–¥—ã (HTTP/2 + cache)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤: ~10 (cache —Ä–∞–±–æ—Ç–∞–µ—Ç)
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤–∏–∑–∏—Ç—ã: <0.3 —Å–µ–∫—É–Ω–¥—ã

## üõ†Ô∏è Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: 502 Bad Gateway
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–ø—É—â–µ–Ω—ã
pm2 status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã
sudo ss -tulpn | grep -E '3000|4000'
```

### –ü—Ä–æ–±–ª–µ–º–∞: 503 Service Temporarily Unavailable
```bash
# Rate limiting —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
# –£–≤–µ–ª–∏—á—å—Ç–µ burst –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo tail -f /var/log/nginx/error.log
```

### –ü—Ä–æ–±–ª–µ–º–∞: Gzip –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å main nginx.conf
sudo nano /etc/nginx/nginx.conf
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–µ—Ç `gzip off;` –≤ –≥–ª–∞–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```
